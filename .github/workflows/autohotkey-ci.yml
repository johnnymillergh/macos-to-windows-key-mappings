name: AutoHotkey CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - 'main'
      - 'develop'
      - 'release/**'
      - 'hotfix/**'
    paths-ignore:
      - '**.md'
      - '_config.yml'

jobs:
  build:
    name: Build & Compile
    runs-on: windows-2025
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Cache AutoHotkey + Compiler
        uses: actions/cache@v4
        with:
          path: C:\Program Files\AutoHotkey
          key: ${{ runner.os }}-autohotkey-v2-compiler-${{ hashFiles('./macOS Keymap.ahk') }}
          restore-keys: |
            ${{ runner.os }}-autohotkey-v2-compiler-
            ${{ runner.os }}-autohotkey-v2-

      - name: Install AutoHotkey
        shell: powershell
        run: |
          if (-not (Test-Path "C:\Program Files\AutoHotkey")) {
            Write-Host "Installing AutoHotkey..."
            winget install AutoHotkey.AutoHotkey --disable-interactivity --accept-source-agreements --location "C:\Program Files\AutoHotkey"
          } else {
            Write-Host "Using cached AutoHotkey installation"
          }
          & "C:\Program Files\AutoHotkey\v2\AutoHotkey.exe" /version

      - name: Install AutoHotkey Compiler
        shell: powershell
        run: |
          Write-Host "Checking for AutoHotkey compiler..."
          if (-not (Test-Path "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe")) {
            Write-Host "Creating Compiler directory..."
            New-Item -ItemType Directory -Path "C:\Program Files\AutoHotkey\Compiler" -Force
            Write-Host "Downloading AutoHotkey compiler from GitHub..."
            $apiUrl = "https://api.github.com/repos/AutoHotkey/Ahk2Exe/releases/latest"
            $releaseInfo = Invoke-RestMethod -Uri $apiUrl
            $zipUrl = $releaseInfo.assets | Where-Object { $_.name -match "^Ahk2Exe.*\.zip$" } | Select-Object -First 1
            $zipPath = "$env:TEMP\ahk2exe.zip"
            Invoke-WebRequest -Uri $zipUrl.browser_download_url -OutFile $zipPath
            Expand-Archive -Path $zipPath -DestinationPath "C:\Program Files\AutoHotkey\Compiler" -Force
            Remove-Item $zipPath -Force
            Write-Host "Compiler installed successfully" -ForegroundColor Green
          } else {
            Write-Host "Compiler already exists" -ForegroundColor Green
          }
          Get-Item "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe"

      - name: Compile AutoHotkey Script
        shell: powershell
        run: |
          Write-Host "Compiling AutoHotkey script to executable..."
          Write-Host "Working directory: $(Get-Location)"
          Write-Host "Listing files..."
          Get-ChildItem -Name *.ahk
          Write-Host "Checking if module files exist..."
          $inputFile = Resolve-Path "macOS Keymap.ahk"
          Write-Host "Input file: $inputFile"
          Write-Host "Running Ahk2Exe compiler..."
          $process = Start-Process -FilePath "C:\Program Files\AutoHotkey\Compiler\Ahk2Exe.exe" -ArgumentList "/in", $inputFile.Path, "/out", "macOS Keymap.exe" -Wait -PassThru -NoNewWindow
          Write-Host "Compiler exit code: $($process.ExitCode)"
          if ($process.ExitCode -ne 0) {
            Write-Error "Compilation failed! Exit code: $($process.ExitCode)"
            exit $process.ExitCode
          }
          Write-Host "Compilation successful! ðŸŽ‰" -ForegroundColor Green
          Get-Item "macOS Keymap.exe"
